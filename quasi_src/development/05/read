shortened varsion of the code,
Need to remove kdelta matrix and implement diagonal addition
This code is a snapshot with kd matrix, can be removed once working
